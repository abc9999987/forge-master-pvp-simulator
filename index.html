<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Forge Master PVP ì˜ˆì¸¡</title>

  <style>
    /* ------------------------------
    Minimal + Cute UI Theme
    ------------------------------ */
    body {
        font-family: "Nunito", "Pretendard", sans-serif;
        background: #faf7f5;
        color: #333;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    h1 {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 20px;
        color: #ff8a7a;
    }

    h3 {
        font-weight: 700;
        margin-top: 0;
        color: #555;
    }

    /* Panel */
    .panel {
        background: white;
        padding: 25px;
        margin-bottom: 25px;
        border-radius: 18px;
        width: 360px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 2px solid #ffe1dc;
    }

    /* Layout */
    .wrap {
        display: flex;
        gap: 40px;
        margin-bottom: 20px;
    }

    /* Label + Input */
    label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0;
        font-size: 14px;
        color: #444;
    }

    input[type="number"] {
        width: 90px;
        padding: 6px 8px;
        border-radius: 10px;
        border: 1.8px solid #ffc5bc;
        background: #fff6f5;
        font-size: 13px;
    }

    /* Button */
    button {
        background: #ff8a7a;
        color: white;
        padding: 12px 26px;
        border-radius: 14px;
        border: none;
        cursor: pointer;
        font-size: 15px;
        font-weight: 700;
        margin-top: 20px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    button:hover { background: #ff7a68; }

    /* Result */
    #battleResult {
        margin-top: 20px;
        font-size: 18px;
        font-weight: 700;
        color: #ff6b5a;
        text-align: center;
    }

    /* Log table wrapper */
    #logWrapper {
        max-height: 260px;
        overflow-y: auto;
        width: 530px;
        margin-top: 20px;
        background: white;
        border-radius: 14px;
        border: 2px solid #ffd7d1;
        box-shadow: 0 4px 10px rgba(0,0,0,0.07);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    table th {
        background: #ffe6e2;
        padding: 10px;
        position: sticky;
        top: 0;
        font-weight: 700;
        color: #444;
    }

    table td {
        padding: 8px;
        border-bottom: 1px solid #f5d2cc;
        text-align: center;
        color: #333;
    }

    .highlight {
        background: #fff0ec;
        font-weight: 700;
        color: #ff6b5a;
    }
    </style>
</head>

<body>

  <h1>Forge Master PVP ì˜ˆì¸¡</h1>

  <div class="wrap">
    <div class="panel" id="blockA">
      <h3>ë‚˜</h3>
      <div class="groupA"></div>
    </div>

    <div class="panel" id="blockB">
      <h3>ì </h3>
      <div class="groupB"></div>
    </div>
  </div>

  <button onclick="startBattle()">ì „íˆ¬ ì‹œì‘!</button>

  <p style="margin-top: 12px; font-size: 14px; color: #666; text-align: center;">
    ì „íˆ¬ëŠ” ìµœëŒ€ 60ì´ˆ ë™ì•ˆ ì§„í–‰ë˜ë©°, ë¨¼ì € ìƒëŒ€ë¥¼ ì“°ëŸ¬ëœ¨ë¦¬ê±°ë‚˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆì„ ë•Œ ì²´ë ¥ì´ ë” ë§ì´ ë‚¨ì€ ìª½ì´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.
  </p>

  <h2 id="battleResult"></h2>
  
  <div id="logWrapper">
    <table id="logTable">
        <thead>
        <tr>
            <th>ì „íˆ¬ ì‹œê°„ (sec)</th>
            <th>ë‚˜</th>
            <th>ì </th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

<script>
/* -----------------------------------------------------------
   UI Generator: automatically creates stat inputs
----------------------------------------------------------- */
const STAT_FIELDS = [
  ["power", "ì´ í”¼í•´"],
  ["hitrate", "ê¸°ë³¸ ê³µê²© ì†ë„"],
  ["speedbuff", "ê³µê²© ì†ë„(%)"],
  ["doubleproc", "ë”ë¸” ì°¬ìŠ¤(%)"],
  ["critproc", "ì¹˜ëª…íƒ€ í™•ë¥ (%)"],
  ["critbonus", "ì¹˜ëª…íƒ€ í”¼í•´(%)"],
  ["drain", "ìƒëª…ë ¥ í¡ìˆ˜(%)"],
  ["regen", "ì²´ë ¥ ì¬ìƒ(%)"],
  ["guard", "ë¸”ë¡ í™•ë¥ (%)"],
  ["vital", "ì´ ì²´ë ¥"],
  ["hpmult", "PVP ì²´ë ¥ ë³´ì •(%)"],
  ["startup", "ê·¼ì ‘ ë”œë ˆì´(ì´ˆ)"]
];

function createInputs(container, prefix) {
  STAT_FIELDS.forEach(([key, label]) => {
    const row = document.createElement("label");
    row.innerHTML = `
      <span>${label}</span>
      <input type="number" id="${prefix}_${key}" value="0" step="0.01">
    `;

    const input = row.querySelector("input");
    input.addEventListener("input", () => {
      if (['doubleproc', 'critproc'].includes(key)) {
        if (input.value > 100) input.value = 100;
      }
      if (input.value < 0) input.value = 0; // ìŒìˆ˜ ë°©ì§€ ì˜µì…˜ (ì›í•˜ë©´ ì œê±°)
    });

    container.appendChild(row);
  });
}

createInputs(document.querySelector(".groupA"), "a");
createInputs(document.querySelector(".groupB"), "b");

document.getElementById("a_power").value = 100;
document.getElementById("a_hitrate").value = 0.588;
document.getElementById("a_vital").value = 1000;
document.getElementById("a_hpmult").value = 500;

document.getElementById("b_power").value = 100;
document.getElementById("b_hitrate").value = 0.588;
document.getElementById("b_vital").value = 1000;
document.getElementById("b_hpmult").value = 500;

/* -----------------------------------------------------------
   Helper
----------------------------------------------------------- */
function num(id) { return +document.getElementById(id).value; }

function pretty(n) {
  return Math.abs(n) >= 1e6
    ? (n / 1e6).toFixed(2) + "M"
    : Math.abs(n) >= 1e3
    ? (n / 1e3).toFixed(2) + "K"
    : n.toFixed(2);
}

/* -----------------------------------------------------------
   Core Combat Math (rewritten structure)
----------------------------------------------------------- */
function loadFighter(prefix) {
  const maxHP = num(prefix + "_vital") * (num(prefix + "_hpmult") / 100);

  return {
    power: num(prefix + "_power"),
    hits: num(prefix + "_hitrate"),
    aspd: num(prefix + "_speedbuff") / 100,
    dbl: num(prefix + "_doubleproc") / 100,
    crit: num(prefix + "_critproc") / 100,
    critDmg: 1.2 + (num(prefix + "_critbonus") / 100),
    drain: num(prefix + "_drain") / 100,
    regen: num(prefix + "_regen") / 100,
    block: num(prefix + "_guard") / 100,
    hp0: num(prefix + "_vital"),
    hpMax: maxHP,
    delay: num(prefix + "_startup")
  };
}

function damagePerSecond(f) {
  const expectedHit =
      f.power *
      ((1 - f.dbl) * (1 - f.crit) +
       (f.dbl * 2) * (1 - f.crit) +
       (1 - f.dbl) * f.crit * f.critDmg +
       f.dbl * 2 * f.crit * f.critDmg);

  return expectedHit * f.hits * (1 + f.aspd);
}

function fightTTD(defender, attacker) {
  const atkDPS = damagePerSecond(attacker) * (1 - defender.block);
  const rawDPS = damagePerSecond(defender) * defender.drain;

  let hp = defender.hpMax;
  let t = 0;
  const dt = 0.1;

  const timeline = [];

  while (hp > 0 && t < 60) {
    const heal = defender.hp0 * defender.regen + (t >= defender.delay ? rawDPS : 0);
    const taken = t >= attacker.delay ? atkDPS : 0;
    const net = taken - heal;

    if (net > 0) hp -= net * dt;

    timeline.push([t.toFixed(1), hp]);

    t += dt;
  }

  return { time: hp > 0 ? Infinity : t, log: timeline, hp };
}

/* -----------------------------------------------------------
   Simulation Runner
----------------------------------------------------------- */
function startBattle() {
  const A = loadFighter("a");
  const B = loadFighter("b");

  const A_TTD = fightTTD(A, B);
  const B_TTD = fightTTD(B, A);

  const out = document.getElementById("battleResult");

  let msg = `
    ë‚´ê°€ ì“°ëŸ¬ì§„ ì‹œê°„: ${A_TTD.time.toFixed(2)}s<br>
    ì ì´ ì“°ëŸ¬ì§„ ì‹œê°„: ${B_TTD.time.toFixed(2)}s<br><br>
  `;

  if (A_TTD.time === Infinity && B_TTD.time === Infinity) {
    msg = `
        ë‚˜ì˜ ë‚¨ì€ ì²´ë ¥: ${A_TTD.hp.toFixed(2)}<br>
        ì ì˜ ë‚¨ì€ ì²´ë ¥: ${B_TTD.hp.toFixed(2)}<br><br>
    `;

    if (A_TTD.hp > B_TTD.hp)
      msg += "ğŸ¥‡ ìŠ¹ë¦¬";
    else if (B_TTD.hp > A_TTD.hp)
      msg += "â˜ ï¸ íŒ¨ë°°";
    else
    msg += "ğŸ¤ ë¬´ìŠ¹ë¶€";
  } else if (A_TTD.time > B_TTD.time)
    msg += "ğŸ¥‡ ìŠ¹ë¦¬";
  else if (B_TTD.time > A_TTD.time)
    msg += "â˜ ï¸ íŒ¨ë°°";
  else
    msg += "ğŸ¤ ë¬´ìŠ¹ë¶€";

  out.innerHTML = msg;

  logTimeline(A_TTD.log, B_TTD.log, A.delay, B.delay);
}

/* -----------------------------------------------------------
   Debug timeline table
----------------------------------------------------------- */
function logTimeline(logA, logB, delayA, delayB) {
  const tb = document.querySelector("#logTable tbody");
  tb.innerHTML = "";

  const len = Math.max(logA.length, logB.length);

  for (let i = 0; i < len; i++) {
    const a = logA[i] || [];
    const b = logB[i] || [];
    const t = a[0] || b[0];

    const row = document.createElement("tr");

    const isAStart = +t === +delayA;
    const isBStart = +t === +delayB;

    row.innerHTML = `
      <td>${t}</td>
      <td class="${isAStart ? "highlight" : ""}">${a[1] ? pretty(+a[1]) : ""}</td>
      <td class="${isBStart ? "highlight" : ""}">${b[1] ? pretty(+b[1]) : ""}</td>
    `;

    tb.appendChild(row);
  }
}

</script>

</body>
</html>
